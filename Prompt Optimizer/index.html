<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PromptOverhaul | AI Cost Optimizer</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-main: #e2e8f0;
            --text-muted: #94a3b8;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --success: #10b981;
            --border: #334155;
            --font-family: 'Segoe UI', system-ui, sans-serif;
            --mono-font: 'Consolas', 'Monaco', monospace;
        }

        * { box-sizing: border-box; outline: none; }

        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header */
        header {
            background: var(--card-bg);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo span { color: var(--text-main); }

        /* Main Layout */
        main {
            flex: 1;
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        /* Controls Section */
        .controls {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            align-items: flex-end;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            flex: 1;
            min-width: 200px;
        }

        label {
            font-size: 0.875rem;
            color: var(--text-muted);
            font-weight: 600;
        }

        select, button {
            padding: 0.75rem 1rem;
            border-radius: 6px;
            font-size: 0.95rem;
            border: 1px solid var(--border);
            background: var(--bg-color);
            color: var(--text-main);
            transition: all 0.2s;
        }

        button.primary {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            font-weight: 600;
            cursor: pointer;
            min-width: 150px;
        }

        button.primary:hover { background: var(--accent-hover); }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Split View Editor */
        .editor-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            flex: 1;
        }

        @media (max-width: 768px) {
            .editor-container { grid-template-columns: 1fr; }
        }

        .pane {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            height: 100%;
        }

        .pane-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .badge {
            background: var(--bg-color);
            padding: 0.25rem 0.75rem;
            border-radius: 99px;
            font-size: 0.75rem;
            border: 1px solid var(--border);
        }

        .stat-row {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        textarea {
            flex: 1;
            min-height: 400px;
            background: var(--bg-color);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            font-family: var(--mono-font);
            font-size: 0.95rem;
            line-height: 1.6;
            color: var(--text-main);
            resize: vertical;
        }

        textarea:focus { border-color: var(--accent); }

        /* Results Styling */
        .result-stats {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
            padding: 1rem;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }

        .savings-big { font-size: 1.25rem; }
        .savings-label { font-size: 0.8rem; opacity: 0.8; display: block; }

        /* Action Bar */
        .actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .copy-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-muted);
            cursor: pointer;
        }

        .copy-btn:hover {
            color: var(--text-main);
            border-color: var(--text-muted);
        }

        /* Info Section */
        .compatibility-info {
            margin-top: 2rem;
            border-top: 1px solid var(--border);
            padding-top: 2rem;
        }
        
        .compatibility-info h3 { margin-top: 0; font-size: 1.1rem; }

        .grid-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .card {
            background: var(--card-bg);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .card h4 { margin: 0 0 0.5rem 0; color: var(--accent); }
        .card p { margin: 0; font-size: 0.85rem; color: var(--text-muted); }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--success);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }
        .toast.show { transform: translateY(0); opacity: 1; }

    </style>
</head>
<body>

<header>
    <div class="logo">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
            <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
            <line x1="12" y1="22.08" x2="12" y2="12"></line>
        </svg>
        Prompt<span>Overhaul</span>
    </div>
    <div style="font-size: 0.9rem; color: var(--text-muted);">
        <span id="engineStatus">Loading Tokenizer...</span>
    </div>
</header>

<main>
    <section class="controls">
        <div class="control-group">
            <label for="targetModel">Target Model Strategy</label>
            <select id="targetModel">
                <option value="universal">Universal Structure (GPT, Claude, Gemini, DeepSeek)</option>
                <option value="gpt">Optimized for GPT-4 / Azure OpenAI</option>
                <option value="claude">Optimized for Claude 3.5 (Anthropic)</option>
                <option value="deepseek">Optimized for DeepSeek (XML Focus)</option>
            </select>
        </div>

        <div class="control-group">
            <label for="outputFormat">Output Syntax</label>
            <select id="outputFormat">
                <option value="xml">XML-Like Format (&lt;task&gt;, &lt;context&gt;)</option>
                <option value="structured">Structured Plain English</option>
                <option value="minimal">Minimal / Low Token Mode</option>
            </select>
        </div>

        <button class="primary" id="optimizeBtn">Overhaul Prompt</button>
    </section>

    <div class="editor-container">
        <!-- Original Prompt -->
        <div class="pane">
            <div class="pane-header">
                <h3>Original Prompt</h3>
                <div class="stat-row">
                    <span id="leakAlert" style="color: #ffcc00; font-weight: bold; display: none;">⚠️ Logic Leaks Detected!</span>
                    <span>Tokens: <b id="originalTokens">0</b></span>
                </div>
            </div>
            <textarea id="inputPrompt" placeholder="Paste your verbose, inefficient prompt here... (e.g., 'Please can you write a function that basically sorts a list, if that's okay?')"></textarea>
        </div>

        <!-- Optimized Prompt -->
        <div class="pane">
            <div class="pane-header">
                <h3>Optimized Result</h3>
                <div class="badge" id="formatBadge">XML Format</div>
            </div>
            
            <textarea id="outputPrompt" readonly placeholder="Optimized result will appear here..."></textarea>
            
            <div class="result-stats" id="savingsBanner" style="opacity: 0;">
                <div>
                    <span class="savings-big" id="savingsPercent">0%</span>
                    <span class="savings-label">Reduction in Input Size</span>
                </div>
                <div>
                    <span class="savings-big" id="savedCost">$0.00</span>
                    <span class="savings-label">Saved per 1M Requests</span>
                </div>
            </div>

            <div class="actions">
                <span class="stat-row" style="margin-right: auto; align-self: center;">
                    New Tokens: <b id="newTokens">0</b>
                </span>
                <button class="copy-btn" id="copyBtn">Copy to Clipboard</button>
            </div>
        </div>
    </div>

    <section class="compatibility-info">
        <h3>Engine Specs</h3>
        <div class="grid-cards">
            <div class="card">
                <h4>cl100k_base Encoding</h4>
                <p>Uses the exact tokenizer model used by GPT-4, GPT-3.5-Turbo, and Text-Embedding-3. No estimates, real math.</p>
            </div>
            <div class="card">
                <h4>Client-Side Privacy</h4>
                <p>Tokenization happens entirely in your browser. No prompt text is sent to any external server.</p>
            </div>
            <div class="card">
                <h4>Cost Model</h4>
                <p>Calculated against an average of $2.50 per 1M Input Tokens (Standard for modern high-end models).</p>
            </div>
        </div>
    </section>
</main>

<div id="toast" class="toast">Copied to clipboard!</div>

<script type="module">
    // Import the tokenizer library from a reliable CDN
    import { encode } from 'https://esm.sh/gpt-tokenizer@2.1.2';
    import { getSemanticDiagnostics } from './SemanticHighlighter.js';

    // --- DOM Elements ---
    const inputEl = document.getElementById('inputPrompt');
    const outputEl = document.getElementById('outputPrompt');
    const originalTokensEl = document.getElementById('originalTokens');
    const newTokensEl = document.getElementById('newTokens');
    const originalCostEl = document.getElementById('originalCost');
    const savingsPercentEl = document.getElementById('savingsPercent');
    const savedCostEl = document.getElementById('savedCost');
    const savingsBanner = document.getElementById('savingsBanner');
    const formatBadge = document.getElementById('formatBadge');
    const optimizeBtn = document.getElementById('optimizeBtn');
    const copyBtn = document.getElementById('copyBtn');
    const engineStatus = document.getElementById('engineStatus');

    // --- Configuration ---
    const PRICE_PER_1M_TOKENS = 2.50;
    
    // --- Tokenizer Logic ---
    function getRealTokenCount(text) {
        if (!text) return 0;
        try {
            // This is the real GPT-4 tokenizer
            const tokens = encode(text);
            return tokens.length;
        } catch (e) {
            console.error("Tokenizer error, falling back to estimation", e);
            // Graceful fallback if CDN fails
            return Math.ceil(text.length / 4); 
        }
    }

    // --- Heuristic Logic ---
    const FLUFF_PHRASES = [
        "please", "kindly", "can you", "could you", "would you be able to", 
        "i need you to", "i want you to", "basically", "essentially", 
        "just", "simply", "actually", "in order to", "make sure to", 
        "ensure that you", "it is important that", "if possible", 
        "if that makes sense", "as a matter of fact"
    ];

    function generateOptimizedPrompt(text, format, modelStrategy) {
        if (!text.trim()) return "";

        let clean = text.trim();
        
        FLUFF_PHRASES.forEach(phrase => {
            const regex = new RegExp(`\\b${phrase}\\b`, 'gi');
            clean = clean.replace(regex, '');
        });

        clean = clean.replace(/\s+/g, ' ').replace(/\s+([.,!?:;])/g, '$1');

        const sentences = clean.split(/(?<=[.!?])\s+/) || [clean];
        
        let rolePart = [];
        let contextPart = [];
        let taskPart = [];
        let constraintPart = [];
        let outputPart = [];

        sentences.forEach(s => {
            const lower = s.toLowerCase();
            if (lower.includes("act as") || lower.includes("you are") || lower.includes("role:")) {
                rolePart.push(s);
            } else if (lower.includes("context:") || lower.includes("background:") || lower.includes("information:")) {
                contextPart.push(s);
            } else if (lower.includes("ensure") || lower.includes("must") || lower.includes("never") || lower.includes("constraint:") || lower.includes("limit")) {
                constraintPart.push(s);
            } else if (lower.includes("output format") || lower.includes("format as") || lower.includes("return as") || lower.includes("json")) {
                outputPart.push(s);
            } else {
                taskPart.push(s);
            }
        });

        let result = "";

        if (format === 'minimal') {
            result = [
                rolePart.length ? "ROLE: " + rolePart.join(" ") : "",
                contextPart.length ? "CTX: " + contextPart.join(" ") : "",
                "TASK: " + taskPart.join(" "),
                constraintPart.length ? "RULES: " + constraintPart.join(" ") : "",
                outputPart.length ? "OUT: " + outputPart.join(" ") : ""
            ].filter(Boolean).join(" | ").replace(/\s+/g, ' ');
        } 
        else if (format === 'xml') {
            result += rolePart.length ? `<role>\n${rolePart.join(" ")}\n</role>\n\n` : "";
            result += contextPart.length ? `<context>\n${contextPart.join(" ")}\n</context>\n\n` : "";
            result += `<instruction>\n${taskPart.join(" ")}\n</instruction>\n\n`;
            
            if (constraintPart.length) {
                result += `<constraints>\n${formatList(constraintPart)}\n</constraints>\n\n`;
            }
            if (outputPart.length) {
                result += `<format>\n${outputPart.join(" ")}\n</format>`;
            }
        } 
        else {
            if (rolePart.length) result += `### Role\n${rolePart.join(" ")}\n\n`;
            if (contextPart.length) result += `### Context\n${contextPart.join(" ")}\n\n`;
            result += `### Task\n${taskPart.join(" ")}\n\n`;
            if (constraintPart.length) {
                result += `### Constraints\n${formatList(constraintPart)}\n\n`;
            }
            if (outputPart.length) {
                result += `### Output Format\n${outputPart.join(" ")}`;
            }
        }

        return result.trim();
    }

    function formatList(arr) {
        return arr.map(item => item.trim()).join('\n- ');
    }

    // --- Stats Logic ---
    function calculateStats(tokenCount) {
        const cost = (tokenCount / 1000000) * PRICE_PER_1M_TOKENS;
        return {
            tokens: tokenCount,
            cost: cost.toFixed(5)
        };
    }

    // --- Event Listeners ---

    // Debounce function to prevent UI lag while typing
    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), wait);
        };
    }

    const updateInputStats = debounce(() => {
        const text = inputEl.value;
        const count = getRealTokenCount(text);
        const stats = calculateStats(count);
        
        // Run the new Semantic Diagnostic
        const diagnostics = getSemanticDiagnostics(text);
        const alertEl = document.getElementById('leakAlert');
        
        if (diagnostics.leaks > 0) {
            alertEl.style.display = 'inline';
            alertEl.title = `Found ${diagnostics.leaks} repetitive concepts.`;
        } else {
            alertEl.style.display = 'none';
        }

        originalTokensEl.textContent = stats.tokens.toLocaleString();
        originalCostEl.textContent = stats.cost;
    }, 300);

    inputEl.addEventListener('input', updateInputStats);

    optimizeBtn.addEventListener('click', () => {
        const text = inputEl.value;
        if (!text.trim()) return;

        const format = document.getElementById('outputFormat').value;
        const strategy = document.getElementById('targetModel').value;

        // Show loading state
        optimizeBtn.textContent = "Optimizing...";
        
        // Optimization is fast enough to run sync, but we use timeout to allow UI update
        setTimeout(() => {
            const optimized = generateOptimizedPrompt(text, format, strategy);
            outputEl.value = optimized;

            // Update Badge
            formatBadge.textContent = format === 'xml' ? 'XML Format' : (format === 'minimal' ? 'Minimal Mode' : 'Structured Text');

            // Calculate Savings
            const origCount = getRealTokenCount(text);
            const newCount = getRealTokenCount(optimized);

            newTokensEl.textContent = newCount.toLocaleString();

            const percentReduced = ((origCount - newCount) / origCount) * 100;
            const moneySaved = ((origCount - newCount) / 1000000) * PRICE_PER_1M_TOKENS;

            savingsPercentEl.textContent = Math.max(0, percentReduced).toFixed(1) + "%";
            savedCostEl.textContent = "$" + Math.max(0, moneySaved).toFixed(2);
            
            savingsBanner.style.opacity = 1;

            if (percentReduced < 20) {
                savingsBanner.style.borderColor = '#eab308';
                savingsBanner.style.color = '#eab308';
                savingsBanner.style.background = 'rgba(234, 179, 8, 0.1)';
            } else {
                savingsBanner.style.borderColor = '#10b981';
                savingsBanner.style.color = '#10b981';
                savingsBanner.style.background = 'rgba(16, 185, 129, 0.1)';
            }

            optimizeBtn.textContent = "Overhaul Prompt";
        }, 50);
    });

    copyBtn.addEventListener('click', () => {
        const text = outputEl.value;
        if (!text) return;

        navigator.clipboard.writeText(text).then(() => {
            const toast = document.getElementById('toast');
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        });
    });

    // Initialize
    engineStatus.textContent = "Tokenizer Active (cl100k_base)";
    inputEl.value = "Please, can you act as a senior Python developer? I need you to write a script that basically parses a CSV file. It is important that you ensure it handles errors gracefully. If possible, output the result in JSON format.";
    updateInputStats();

</script>

</body>
</html>